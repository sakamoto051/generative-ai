# Track Spec: Material Requirements Planning (MRP) Calculation Engine

## Overview
このトラックでは、製品の生産予定数量に基づき、BOM（部品表）を多階層に展開して、必要な原材料および中間品の総量（総所要量）と、在庫を差し引いた不足分（正味所要量）を算出する計算エンジンを実装します。

## Functional Requirements

### 1. 在庫管理機能の基礎
- **在庫テーブル (`inventories`) の新設:** 品目（Product/Material）ごとの現在庫数を保持する。
- **在庫更新API（簡易版）:** MRPのテストや動作確認のために、手動で在庫数を設定できる機能。

### 2. MRP計算エンジン
- **エンドポイント (`POST /api/mrp/calculate`):** 指定された製品IDと生産予定数量を受け取り、計算結果を返す。
- **多階層正味所要量計算:**
    1. 最上位の製品から順にBOMを展開。
    2. 各階層で「必要量」に対し「在庫テーブル」から在庫を引き当てる。
    3. 在庫で賄えない「不足分」がある場合のみ、その子部品（中間品・材料）の計算へ進む。
- **計算結果の階層構造化:** どの工程で何が不足しているかを把握できるよう、ネストされた構造または詳細なリスト形式で結果を返す。

### 3. 計算ロジックの詳細
- **再帰的展開:** 既存の `BomService` を拡張または利用し、在庫引き当てを伴う再帰計算を行う。
- **中間品在庫の考慮:** 中間品の在庫がある場合はそれを使用し、下の階層への展開をストップまたは削減する。

## Non-Functional Requirements
- **正確性:** 浮動小数点数による誤差を最小限に抑える（PHPの `bcmath` 等の検討、または十分な精度の確保）。
- **拡張性:** 将来的に「リードタイム（納期）」や「仕掛品」を考慮した計算への拡張を可能にする設計。

## Acceptance Criteria
- 製品Aを10個作る際、中間品B（在庫5個）が必要な場合、中間品Bの「正味所要量」が5個となり、その下の原材料Cの計算が「5個分」に基づいて行われること。
- 最終的なレスポンスに、各品目の「総所要量」「在庫引当数」「正味所要量」が含まれていること。
- 在庫不足が発生しない（在庫が十分にある）場合、下位の材料展開が行われないか、正味所要量が0として正しく計算されること。

## Out of Scope
- **発注自動生成:** 計算結果に基づいた発注書の自動作成は別トラックとする。
- **リードタイム考慮:** 納期から逆算した着手日の計算（タイムフェーズドMRP）は今回は含めない。
- **仕掛品引当:** 現在製造中の仕掛品を在庫としてカウントするロジックは含めない。
